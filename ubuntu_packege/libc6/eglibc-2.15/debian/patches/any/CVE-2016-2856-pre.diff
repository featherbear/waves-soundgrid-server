From e4608715e6e1dd2adc91982fd151d5ba4f761d69 Mon Sep 17 00:00:00 2001
From: Carlos O'Donell <carlos@redhat.com>
Date: Fri, 19 Jul 2013 02:42:03 -0400
Subject: [PATCH] CVE-2013-2207, BZ #15755: Disable pt_chown.

The helper binary pt_chown tricked into granting access to another
user's pseudo-terminal.

Pre-conditions for the attack:

 * Attacker with local user account
 * Kernel with FUSE support
 * "user_allow_other" in /etc/fuse.conf
 * Victim with allocated slave in /dev/pts

Using the setuid installed pt_chown and a weak check on whether a file
descriptor is a tty, an attacker could fake a pty check using FUSE and
trick pt_chown to grant ownership of a pty descriptor that the current
user does not own.  It cannot access /dev/pts/ptmx however.

In most modern distributions pt_chown is not needed because devpts
is enabled by default. The fix for this CVE is to disable building
and using pt_chown by default. We still provide a configure option
to enable hte use of pt_chown but distributions do so at their own
risk.

	[BZ #15755]
	* config.h.in: Define HAVE_PT_CHOWN.
	* config.make.in (build-pt-chown): New variable.
	* configure.in (--enable-pt_chown): New configure option.
	* configure: Regenerate.
	* login/Makefile: Include Makeconfig.  Build pt_chown only if
	build-pt-chown is enabled.
	* sysdeps/unix/grantpt.c (grantpt) [HAVE_PT_CHOWN]: Spawn
	pt_chown to fix pty ownership.
	* sysdeps/unix/sysv/linux/grantpt.c [HAVE_PT_CHOWN]: Define
	CLOSE_ALL_FDS.
	* manual/install.texi (Configuring and compiling): Mention
	--enable-pt_chown. Add @findex for grantpt.
	* INSTALL: Regenerate.

* CVE-2013-2207 Incorrectly granting access to another user's pseudo-terminal
  has been fixed by disabling the use of pt_chown (Bugzilla #15755).
  Distributions can re-enable building and using pt_chown via the new configure
  option `--enable-pt_chown'.  Enabling the use of pt_chown carries with it
  considerable security risks and should only be used if the distribution
  understands and accepts the risks.
 
[Note: backport to glibc 2.15. --sbeattie]
---
 INSTALL                           |   12 ++++++++++++
 config.h.in                       |    3 +++
 config.make.in                    |    1 +
 configure                         |   16 ++++++++++++++++
 configure.in                      |   10 ++++++++++
 login/Makefile                    |    8 +++++++-
 manual/install.texi               |   14 ++++++++++++++
 sysdeps/unix/grantpt.c            |    8 +++++---
 sysdeps/unix/sysv/linux/grantpt.c |    5 +++--
 9 files changed, 71 insertions(+), 6 deletions(-)

Index: b/INSTALL
===================================================================
--- a/INSTALL
+++ b/INSTALL
@@ -150,6 +150,18 @@ will be used, and CFLAGS sets optimizati
      this can be prevented though there generally is no reason since it
      creates compatibility problems.
 
+`--enable-pt_chown'
+     The file `pt_chown' is a helper binary for `grantpt' (*note
+     Pseudo-Terminals: Allocation.) that is installed setuid root to
+     fix up pseudo-terminal ownership.  It is not built by default
+     because systems using the Linux kernel are commonly built with the
+     `devpts' filesystem enabled and mounted at `/dev/pts', which
+     manages pseudo-terminal ownership automatically.  By using
+     `--enable-pt_chown', you may build `pt_chown' and install it
+     setuid and owned by `root'.  The use of `pt_chown' introduces
+     additional security risks to the system and you should enable it
+     only if you understand and accept those risks.
+
 `--build=BUILD-SYSTEM'
 `--host=HOST-SYSTEM'
      These options are for cross-compiling.  If you specify both
Index: b/config.h.in
===================================================================
--- a/config.h.in
+++ b/config.h.in
@@ -233,4 +233,7 @@
 
 #define HAVE_REGEX 1
 
+/* The pt_chown binary is being built and used by grantpt.  */
+#undef HAVE_PT_CHOWN
+
 #endif
Index: b/config.make.in
===================================================================
--- a/config.make.in
+++ b/config.make.in
@@ -101,6 +101,7 @@ add-on-subdirs = @add_on_subdirs@
 sysdeps-add-ons = @sysdeps_add_ons@
 cross-compiling = @cross_compiling@
 force-install = @force_install@
+build-pt-chown = @build_pt_chown@
 
 # Build tools.
 CC = @CC@
Index: b/configure
===================================================================
--- a/configure
+++ b/configure
@@ -729,6 +729,7 @@ multi_arch
 base_machine
 add_on_subdirs
 add_ons
+build_pt_chown
 libc_cv_nss_crypt
 REPORT_BUGS_TEXI
 REPORT_BUGS_TO
@@ -832,6 +833,7 @@ with_pkgversion
 with_bugurl
 enable_multi_arch
 enable_nss_crypt
+enable_pt_chown
 with_cpu
 '
       ac_precious_vars='build_alias
@@ -1501,6 +1503,7 @@ Optional Features:
   --enable-multi-arch     enable single DSO with optimizations for multiple
                           architectures
   --enable-nss-crypt      enable libcrypt to use nss
+  --enable-pt_chown       Enable building and installing pt_chown
 
 Optional Packages:
   --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
@@ -3973,6 +3976,19 @@ else
 fi
 
 
+# Check whether --enable-pt_chown was given.
+if test "${enable_pt_chown+set}" = set; then :
+  enableval=$enable_pt_chown; build_pt_chown=$enableval
+else
+  build_pt_chown=no
+fi
+
+
+if test $build_pt_chown = yes; then
+  $as_echo "#define HAVE_PT_CHOWN 1" >>confdefs.h
+
+fi
+
 # The way shlib-versions is used to generate soversions.mk uses a
 # fairly simplistic model for name recognition that can't distinguish
 # i486-pc-linux-gnu fully from i486-pc-gnu.  So we mutate a $host_os
Index: b/configure.in
===================================================================
--- a/configure.in
+++ b/configure.in
@@ -295,6 +295,16 @@ else
 fi
 AC_SUBST(libc_cv_nss_crypt)
 
+AC_ARG_ENABLE([pt_chown],
+	      [AS_HELP_STRING([--enable-pt_chown],
+	       [Enable building and installing pt_chown])],
+	      [build_pt_chown=$enableval],
+	      [build_pt_chown=no])
+AC_SUBST(build_pt_chown)
+if test $build_pt_chown = yes; then
+  AC_DEFINE(HAVE_PT_CHOWN)
+fi
+
 # The way shlib-versions is used to generate soversions.mk uses a
 # fairly simplistic model for name recognition that can't distinguish
 # i486-pc-linux-gnu fully from i486-pc-gnu.  So we mutate a $host_os
Index: b/login/Makefile
===================================================================
--- a/login/Makefile
+++ b/login/Makefile
@@ -32,10 +32,16 @@ routines-$(OPTION_EGLIBC_UTMP) \
 
 CFLAGS-grantpt.c = -DLIBEXECDIR='"$(libexecdir)"'
 
-others = pt_chown
+others =
 others-$(OPTION_EGLIBC_UTMP) += utmpdump
+
+include ../Makeconfig
+
+ifeq (yes,$(build-pt-chown))
+others += pt_chown
 others-pie = pt_chown
 install-others-programs = $(inst_libexecdir)/pt_chown
+endif
 
 distribute := utmp-private.h utmp-equal.h pty-private.h
 
Index: b/manual/install.texi
===================================================================
--- a/manual/install.texi
+++ b/manual/install.texi
@@ -160,6 +160,20 @@ if the used tools support it.  By using
 prevented though there generally is no reason since it creates
 compatibility problems.
 
+@pindex pt_chown
+@findex grantpt
+@item --enable-pt_chown
+The file @file{pt_chown} is a helper binary for @code{grantpt}
+(@pxref{Allocation, Pseudo-Terminals}) that is installed setuid root to
+fix up pseudo-terminal ownership.  It is not built by default because
+systems using the Linux kernel are commonly built with the @code{devpts}
+filesystem enabled and mounted at @file{/dev/pts}, which manages
+pseudo-terminal ownership automatically.  By using
+@samp{--enable-pt_chown}, you may build @file{pt_chown} and install it
+setuid and owned by @code{root}.  The use of @file{pt_chown} introduces
+additional security risks to the system and you should enable it only if
+you understand and accept those risks.
+
 @item --build=@var{build-system}
 @itemx --host=@var{host-system}
 These options are for cross-compiling.  If you specify both options and
Index: b/sysdeps/unix/grantpt.c
===================================================================
--- a/sysdeps/unix/grantpt.c
+++ b/sysdeps/unix/grantpt.c
@@ -174,9 +174,10 @@ grantpt (int fd)
   retval = 0;
   goto cleanup;
 
-  /* We have to use the helper program.  */
+  /* We have to use the helper program if it is available.  */
  helper:;
 
+#ifdef HAVE_PT_CHOWN
   pid_t pid = __fork ();
   if (pid == -1)
     goto cleanup;
@@ -191,9 +192,9 @@ grantpt (int fd)
 	if (__dup2 (fd, PTY_FILENO) < 0)
 	  _exit (FAIL_EBADF);
 
-#ifdef CLOSE_ALL_FDS
+# ifdef CLOSE_ALL_FDS
       CLOSE_ALL_FDS ();
-#endif
+# endif
 
       execle (_PATH_PT_CHOWN, basename (_PATH_PT_CHOWN), NULL, NULL);
       _exit (FAIL_EXEC);
@@ -232,6 +233,7 @@ grantpt (int fd)
 	    assert(! "getpt: internal error: invalid exit code from pt_chown");
 	  }
     }
+#endif
 
  cleanup:
   if (buf != _buf)
Index: b/sysdeps/unix/sysv/linux/grantpt.c
===================================================================
--- a/sysdeps/unix/sysv/linux/grantpt.c
+++ b/sysdeps/unix/sysv/linux/grantpt.c
@@ -10,7 +10,7 @@
 #include "not-cancel.h"
 #include "pty-private.h"
 
-
+#if HAVE_PT_CHOWN
 /* Close all file descriptors except the one specified.  */
 static void
 close_all_fds (void)
@@ -37,6 +37,7 @@ close_all_fds (void)
       __dup2 (STDOUT_FILENO, STDERR_FILENO);
     }
 }
-#define CLOSE_ALL_FDS() close_all_fds()
+# define CLOSE_ALL_FDS() close_all_fds()
+#endif
 
 #include <sysdeps/unix/grantpt.c>

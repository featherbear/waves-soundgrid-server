From 6e230d11837f3ae7b375ea69d7905f0d18eb79e5 Mon Sep 17 00:00:00 2001
From: Siddhesh Poyarekar <siddhesh@redhat.com>
Date: Wed, 6 Jun 2012 18:39:10 +0530
Subject: [PATCH] Fix validation check when converting from ibm930 to utf

[BZ #14134]

When converting IBM930 code with iconv(), if IBM930 code which
includes invalid multibyte character "0xffff" is specified, then
iconv() segfaults. This is easy to see using the following command:

echo '0x0e 0x43 0x8c 0xff 0xff 0x43 0xbd 0x43 0xbd' | xxd -r |
	iconv -f IBM930 -t UTF-8
---
 ChangeLog          |    7 +++++++
 NEWS               |    2 +-
 iconvdata/ibm930.c |    5 +++--
 3 files changed, 11 insertions(+), 3 deletions(-)

Index: eglibc-2.15/iconvdata/ibm930.c
===================================================================
--- eglibc-2.15.orig/iconvdata/ibm930.c	2014-12-02 11:20:15.186594028 -0500
+++ eglibc-2.15/iconvdata/ibm930.c	2014-12-02 11:20:15.182593993 -0500
@@ -163,7 +163,8 @@
 	while (ch > rp2->end)						      \
 	  ++rp2;							      \
 									      \
-	if (__builtin_expect (ch < rp2->start, 0)			      \
+	if (__builtin_expect (rp2->start == 0xffff, 0)			      \
+	    || __builtin_expect (ch < rp2->start, 0)			      \
 	    || (res = __ibm930db_to_ucs4[ch + rp2->idx],		      \
 		__builtin_expect (res, L'\1') == L'\0' && ch != '\0'))	      \
 	  {								      \
